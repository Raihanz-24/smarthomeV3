<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register - SmartHome</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
</head>

<body class="bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md space-y-4">
        <h1 class="text-3xl font-bold text-center text-green-600">SmartHome</h1>
        <p class="text-center text-gray-500 text-sm">Created by Raihan</p>

        <form id="registerForm" class="space-y-4">
            <input type="text" id="username" placeholder="Username" class="w-full border px-4 py-2 rounded-lg"
                required />
            <input type="password" id="password" placeholder="Password" class="w-full border px-4 py-2 rounded-lg"
                required />
            <input type="text" id="token" placeholder="Token Pendaftaran" class="w-full border px-4 py-2 rounded-lg"
                required />
            <button type="submit"
                class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">Register</button>
        </form>

        <p id="message" class="text-sm text-center text-red-500 mt-2"></p>
        <p class="text-sm text-center mt-4">Sudah punya akun? <a href="index.html"
                class="text-green-600 hover:underline">Login di sini</a></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            databaseURL: "YOUR_DATABASE_URL",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MSG_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const fixedToken = "rahasia123"; // ubah sesuai token Anda

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const fp = await FingerprintJS.load();
        const result = await fp.get();
        const visitorId = result.visitorId;

        document.getElementById("registerForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const token = document.getElementById("token").value.trim();
            const message = document.getElementById("message");

            if (token !== fixedToken) {
                message.textContent = "Token salah.";
                return;
            }

            const hashedPassword = await hashPassword(password);

            await set(ref(db, "users/" + username), {
                password: hashedPassword,
                deviceId: visitorId
            });

            message.classList.remove("text-red-500");
            message.classList.add("text-green-600");
            message.textContent = "Berhasil mendaftar. Silakan login.";
        });
    </script>
</body>

</html>